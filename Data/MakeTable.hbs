-- switch       - MakeTable
-- https://bitbucket.org/codeasaurus/switch
-- Description  - Template to generate a SQL Server MakeTable from View script similar to MSAccess MakeTable
--

--CREATE TABLE
{{#each Items}}	
CREATE TABLE [DATABASE_NAME].[SCHEMA].[tbl{{Name}}](
	{{#each Columns}}[{{Name}}] [{{DataTypeNameComplete}}] {{#xIf IsNullable "===" true}}NULL{{else}}NOT NULL{{/xIf}} {{xNotLast ","}}
	{{/each}})
{{/each}}


--INSERT TABLE
{{#each Items}}			
INSERT INTO [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME]
		   ({{#each Columns}}{{xNotFirst ", "}}[{{Name}}]{{/each}})
		SELECT {{#each Columns}}{{xNotFirst ", "}}s.[{{Name}}]{{/each}}
			FROM [{{Database.Name}}].[{{Schema}}].[{{Name}}] s 
				LEFT JOIN [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME] d ON s.RowID = d.RowID
			WHERE s.LastUpdate > @LastSyncDate AND d.RowID IS NULL
.
{{/each}}


--UPDATE TABLE
{{#each Items}}			
UPDATE [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME]
SET
	{{#each Columns}}{{Name}} = s.{{Name}}{{xNotLast ", "}}
	{{/each}}
FROM [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME] d 
	INNER JOIN [{{Database.Name}}].[{{Schema}}].[{{Name}}] s
		ON d.RowID = s.RowID
.
{{/each}}

--DELETE ROWS
{{#each Items}}			
DELETE FROM [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME]
WHERE RowID IN (
	SELECT d.RowID
	FROM [{{Database.Name}}].[{{Schema}}].[{{Name}}] s 
		RIGHT JOIN [DATEBASE_NAME].[SCHEMA].[DESTINATION_NAME] d ON s.RowID = d.RowID
	WHERE s.RowID IS NULL
	AND d.LastUpdate > @LastSyncDate
)
.
{{/each}}